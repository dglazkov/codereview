<link rel="import" href="../third_party/polymer-all/polymer-elements/polymer-ajax/polymer-ajax.html">

<polymer-element name="rietveld-issue" attributes="server number">
  <template>
    <polymer-ajax
        auto
        url="{{ server }}/api/{{number}}"
        handleAs="json"
        id="ajax"
        on-polymer-response="issueLoadSucceeded"
        on-polymer-error="issueLoadFailed">
    </polymer-ajax>
    <style>
    .description {
      white-space: pre;
    }
    </style>
    <template if="{{ data }}">
      <h1 class="subject">{{ data.subject }}</h1>
      <div class="description">{{ data.description }}</div>
      <div class="recipients">
        <div class="reviewers">
          <template repeat="{{ email in data.reviewers }}">
            <span class="email">{{ email }}</span>
          </template>
        </div>
        <div class="cc">
          <template repeat="{{ email in data.cc }}">
            <span class="email">{{ email }}</span>
          </template>
        </div>
      </div>
      <label>Closed: <input type="checkbox" checked="{{ data.closed }}"></label>
      <label>Commit: <input type="checkbox" checked="{{ data.commit }}"></label>
      <label>Private: <input type="checkbox" checked="{{ data.private }}"></label>
      <div class="created">{{ data.created }}</div>
      <div class="modified">{{ data.modified }}</div>
      <div class="owner"><span class="name">{{ data.owner }}</span><span class="email">{{ data.owner_email }}</span></div>
      <template repeat="{{ patchset in data.patchsets }}">
        <rietveld-patchset server="{{ server }}" issue="{{ number }}" patchset="{{ patchset }}"></rietveld-patchset>
      </template>
    </template>

    <template if="{{ error }}">
      <h1>Issue {{number}} failed to load.</h1>
      <p>{{error}}</p>
    </template>
  </template>
  <script>
  Polymer('rietveld-issue', {
    server: '',
    number: '',
    data: null,
    error: '',
    issueLoadSucceeded: function(event) {
      this.data = event.detail.response;
      this.error = '';
    },
    issueLoadFailed: function(event) {
      this.data = null;
      this.error = event.detail.response;
    },
  });
  </script>
</polymer-element>
<polymer-element name="rietveld-patchset" attributes="server issue patchset">
  <template>
    <polymer-ajax
        auto
        url="{{ server }}/api/{{ issue }}/{{ patchset }}"
        handleAs="json"
        id="ajax"
        on-polymer-response="patchsetLoadSucceeded"
        on-polymer-error="patchsetLoadFailed">
    </polymer-ajax>
    <!--
      The API we need doesn't have CORS headers yet:
      https://codereview.appspot.com/12739044/
      For now, we can test with a local server.
    -->
    <template if="{{ data }}">
      <div class="files">
        <template repeat="{{ file in data.files }}">
          <div class="file">
            <div class="status">{{ file.value.status }}</div>
            <div class="name">{{ file.key }}</div>
            <rietveld-diffview diff="{{ file.value.text }}"></rietveld-diffview>
          </div>
        </template>
      </div>
      <div class="created">{{ data.created }}</div>
      <div class="modified">{{ data.modified }}</div>
      <div class="owner"><span class="name">{{ data.owner }}</span><span class="email">{{ data.owner_email }}</span></div>
    </template>

    <template if="{{ error }}">
      <h2>Patchset {{ patchset }} failed to load.</h2>
      <p>{{error}}</p>
    </template>
  </template>
  <script>
  Polymer('rietveld-patchset', {
    server: '',
    issue: '',
    patchset: '',
    data: null,
    error: '',

    massage_: function(data) {
      function flatten(map) {
        var result = [];
        for (var key in map) {
          result.push({
            key: key,
            value: map[key],
          });
        }
        return result;
      }
      data.files = flatten(data.files);
    },

    patchsetLoadSucceeded: function(event) {
      this.massage_(event.detail.response);
      this.data = event.detail.response;
      console.log(this.data);
      this.error = '';
    },
    patchsetLoadFailed: function(event) {
      this.data = null;
      this.error = event.detail.response;
    },
  });
  </script>
</polymer-element>
<polymer-element name="rietveld-diffview" attributes="diff">
  <template>
    <style>
    @-webkit-keyframes slide-in {
       0%   { width: 200%; }
       100% { width: 100%; }
    }
    @-webkit-keyframes slide-out {
       0%   { width: 100%; }
       100% { width: 200%; }
    }
    @-webkit-keyframes hide-line-numbers {
       0%   { width: 2em; }
       100% { width: 0; }
    }
    @-webkit-keyframes show-line-numbers {
       0%   { width: 0; }
       100% { width: 2em; }
    }
    .lines {
      font-family: monospace;
      overflow-x: hidden;
    }
    .left, .right {
      flex: 1;
    }
    .side-by-side .left .add,
    .side-by-side .right .remove {
      display: none;
    }
    .animate.side-by-side .left .after,
    .animate.side-by-side .right .before {
      -webkit-animation-name: hide-line-numbers;
      -webkit-animation-duration: 0.3s;
      -webkit-animation-timing-function: ease-in-out;
      width: 0;
    }
    :not(.animate).side-by-side .left .after,
    :not(.animate).side-by-side .right .before {
      width: 0;
    }
    .animate.unified .left .after,
    .animate.unified .right .before {
      -webkit-animation-name: show-line-numbers;
      -webkit-animation-duration: 0.3s;
      -webkit-animation-timing-function: ease-in-out;
      width: 2em;
    }
    .group {
      display: flex;
    }
    .animate.side-by-side .group {
      -webkit-animation-name: slide-in;
      -webkit-animation-duration: 0.3s;
      -webkit-animation-timing-function: ease-in-out;
      width: 100%;
    }
    :not(.animate).side-by-side .group {
      width: 100%;
    }
    .animate.unified .group {
      -webkit-animation-name: slide-out;
      -webkit-animation-duration: 0.3s;
      -webkit-animation-timing-function: ease-in-out;
      width: 200%;
    }
    :not(.animate).animate.unified .group {
      width: 100%;
    }
    :not(.animate).unified .right {
      display: none;
    }
    .line {
      display: flex;
    }
    .line-number {
      flex-shrink: 0;
      width: 2em;
      text-align: right;
      -webkit-user-select: none;
      color: #999;
      background-color: #f8f8ff;
      white-space: pre;
      overflow: hidden;
    }
    .text {
      white-space: pre-wrap;
      word-break: break-all;
      padding: 2px;
    }
    .add {
      background-color: #dfd;
    }
    .remove {
      background-color: #fdd;
    }
    .header {
      color: #999;
      background-color: #f8f8ff;
    }
    </style>
    <button on-click="onToggle">toggle</button>
    <div id="d" class="lines side-by-side" on-webkitAnimationEnd="onAnimationEnd">
      <template repeat="{{ group in data.groups }}">
        <div class="group">
          <div class="left">
            <template repeat="{{ line in group }}">
              <div class="line {{ line.type }}"><!--
              --><div class="before line-number">{{ line.beforeLine }}</div><!--
              --><div class="after line-number">{{ line.afterLine }}</div><!--
              --><div class="text">{{ line.text }}</div><!--
            --></div>
            </template>
          </div>
          <div class="right">
            <template repeat="{{ line in group }}">
              <div class="line {{ line.type }}"><!--
              --><div class="before line-number">{{ line.beforeLine }}</div><!--
              --><div class="after line-number">{{ line.afterLine }}</div><!--
              --><div class="text">{{ line.text }}</div><!--
            --></div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </template>
  <script>
  (function() {
    function parseHeader(header) {
      var i = 0;
      if (header[i++] != '@')
        throw 'Malformed header: ' + header;
      if (header[i++] != '@')
        throw 'Malformed header: ' + header;
      if (header[i++] != ' ')
        throw 'Malformed header: ' + header;
      if (header[i++] != '-')
        throw 'Malformed header: ' + header;
    }

    function parseLine(line) {
      var c = line[0];
      var type = 'unchanged';
      if (c == '@') {
        type = 'header';
        parseHeader.call(this, line);
      } else if (c == '+') {
        type = 'add';
        line = line.slice(1);
        ++this.afterLine;
      } else if (c == '-') {
        type = 'remove';
        line = line.slice(1);
        ++this.beforeLine;
      } else {
        type = 'both';
        line = line.slice(1);
        ++this.afterLine;
        ++this.beforeLine;
      }
      return {
        beforeLine: this.beforeLine,
        afterLine: this.afterLine,
        type: type,
        text: line,
      };
    }

    function groupByType(ungroupedLines) {
      var result = [];
      var currentType = 'header';
      var currentLines = [];
      for (var i = 0; i < ungroupedLines.length; ++i) {
        var line = ungroupedLines[i];
        var type = line.type;
        if (type == 'remove')
          type = 'add'; // We group add and remove together.
        if (type == currentType) {
          currentLines.push(line);
          continue;
        }
        if (currentLines.length)
          result.push(currentLines);
        currentLines = [];
        currentType = type;
        currentLines.push(line);
      }
      if (currentLines.length)
        result.push(currentLines);
      return result;
    }

    function parseDiff(diff) {
      if (!diff)
        return null;
      var state = {
        beforeLine: 0,
        afterLine: 0,
      };
      return {
        groups: groupByType(diff.split('\n').map(parseLine, state)),
      };
    }

    Polymer('rietveld-diffview', {
      diff: null,
      data: null,

      onAnimationEnd: function() {
        console.log('onAnimationEnd');
      },

      onToggle: function() {
        var classList = this.$.d.classList;
        if (classList.contains('unified')) {
          classList.remove('unified');
          classList.add('animate', 'side-by-side');
        } else {
          classList.remove('side-by-side');
          classList.add('animate', 'unified');
        }
      },

      diffChanged: function() {
        this.data = parseDiff(this.diff);
      },
    });
  })();
  </script>
</polymer-element>
